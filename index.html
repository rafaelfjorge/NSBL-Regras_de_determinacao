<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Combinações</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <h1>Gerador de Combinações</h1>
    <form>
        <label for="cfops">CFOPs:</label>
        <input type="text" name="cfops" id="cfops"><br><br>

        <label for="estado_emissor">Estado Emissor:</label>
        <input type="text" name="estado_emissor" id="estado_emissor"><br><br>

        <label for="regime_emissor">Regime Emissor:</label>
        <input type="text" name="regime_emissor" id="regime_emissor"><br><br>

        <label for="linha_emissor">Linha Emissor:</label>
        <input type="text" name="linha_emissor" id="linha_emissor"><br><br>

        <label for="estado_destinatario">Estado Destinatário:</label>
        <input type="text" name="estado_destinatario" id="estado_destinatario"><br><br>

        <label for="regime_destinatario">Regime Destinatário:</label>
        <input type="text" name="regime_destinatario" id="regime_destinatario"><br><br>

        <label for="linha_destinatario">Linha Destinatário:</label>
        <input type="text" name="linha_destinatario" id="linha_destinatario"><br><br>

        <button type="button" id="gerar_combinacoes">Gerar Combinacoes</button>
        <button type="button" id="exportar_csv">Exportar CSV</button>
        <button type="button" id="limpar_resultados">Limpar Resultados</button>
    </form>

    <div id="resultado"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('#gerar_combinacoes').addEventListener('click', function () {
                var cfops = document.querySelector('#cfops').value.split(/[,\|]+/);
                var estados_emissor = document.querySelector('#estado_emissor').value.split(/[,\|]+/);
                var estados_destinatario = document.querySelector('#estado_destinatario').value.split(/[,\|]+/);
                var regime_emissor = document.querySelector('#regime_emissor').value.split(/[,\|]+/);
                var regime_destinatario = document.querySelector('#regime_emissor').value.split(/[,\|]+/);
                var linha_emissor = document.querySelector('#linha_emissor').value.split(/[,\|]+/);
                var linha_destinatario = document.querySelector('#linha_destinatario').value.split(/[,\|]+/);

                var combinacoes = cartesianProduct([estados_emissor, estados_destinatario, cfops, regime_emissor, regime_destinatario]);
                var combinacoes_geral = cartesianProduct([estados_emissor, estados_destinatario, cfops, regime_emissor, regime_destinatario, linha_emissor, linha_destinatario]);

                var resultado = "<h2>Resultado das Combinações:" + " " + combinacoes.length + "</h2><ul>";
                for (var i = 0; i < combinacoes.length; i++) {
                    resultado += "<li>" + combinacoes[i][0] + " > " + combinacoes[i][1] + " | " + combinacoes[i][2] + " | " + combinacoes[i][3] + " & " + combinacoes[i][4] + " Detalhe da regra " + combinacoes_geral[i].join(', ') + "</li>";
                    //resultado += "<li>" + combinacoes_geral[i].join(', ') + "</li>";
                }
                resultado += "</ul>";

                document.querySelector('#resultado').innerHTML = resultado;
            });

            document.querySelector('#exportar_csv').addEventListener('click', function () {
                var cfops = document.querySelector('#cfops').value.split(/[,\|]+/);
                var estados_emissor = document.querySelector('#estado_emissor').value.split(/[,\|]+/);
                var estados_destinatario = document.querySelector('#estado_destinatario').value.split(/[,\|]+/);
                var regime_emissor = document.querySelector('#regime_emissor').value.split(/[,\|]+/);
                var regime_destinatario = document.querySelector('#regime_emissor').value.split(/[,\|]+/);
                var linha_emissor = document.querySelector('#linha_emissor').value.split(/[,\|]+/);
                var linha_destinatario = document.querySelector('#linha_destinatario').value.split(/[,\|]+/);

                //var combinacoes = cartesianProduct([estados_emissor, estados_destinatario, cfops, regime_emissor, regime_destinatario]);
                

                var nome_da_regra = cartesianProduct([estados_emissor, estados_destinatario, cfops, regime_emissor, regime_destinatario]);
                var combinacoes_geral = cartesianProduct([estados_emissor, estados_destinatario, cfops, regime_emissor, regime_destinatario, linha_emissor, linha_destinatario]);
                //novo
                //var nome_da_regra = cartesianProduct([estados_emissor, estados_destinatario, cfops, regime_emissor, regime_destinatario]);
                //novo

                var csvContent = "Nome Da Regra;Estado Emissor;Estado Destinatario;CFOP;Regime Emissor;Regime Destinatario;Linha Emissor; Linha destinatario\n";

                for (var i = 0; i < combinacoes_geral.length; i++) {
                    //csvContent += combinacoes[i].join(';') + "\n";
                    var concatRegra = nome_da_regra[i][0] + " > " + nome_da_regra[i][1] + " | " + nome_da_regra[i][2] + " | " + nome_da_regra[i][3] + " & " + nome_da_regra[i][4];  
                    //nome_da_regra[i].join(' > ');
                    csvContent += concatRegra + ';' + combinacoes_geral[i].join(';') + "\n";
                }

                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                saveAs(blob, 'combinacoes.csv');
            });

            function cartesianProduct(arrays) {
                return arrays.reduce(function (a, b) {
                    var result = [];
                    a.forEach(function (x) {
                        b.forEach(function (y) {
                            result.push(x.concat([y]));
                        });
                    });
                    return result;
                }, [[]]);
            }

            document.querySelector('#limpar_resultados').addEventListener('click', function () {
                document.querySelector('#resultado').innerHTML = '';
            });
        });
    </script>
</body>
</html>
